# 地理院タイル目録を用いた地理院タイルの効率的な同期方法
# An effective synchronization method of GSI Tiles using a GSI Tile List

地理空間情報部　情報普及課　藤村　英範
Information Access Division, Geospatial Information Department
Hidenori FUJIMURA

## 要旨
電子地形図（タイル）をはじめとする基本測量成果を含み，政府オープンデータ戦略に基づいて国土地理院コンテンツ利用規約に従い提供されるウェブ地図用地理空間情報「地理院タイル」は，基本図（地形図），写真（オルソ画像），主題図，災害情報を含む1,000レイヤを超える情報セットとなっている．これら地理院タイルは，もっぱらインターネット提供により提供を行う方針となっており，情報普及課が運用する地理院地図タイル用ウェブサーバである「地理院地図サーバ」の可用性を確保しつつ，測量法第27条第2項に基づくインターネット提供を適切に実施する必要があった．このため，地理院地図サーバから提供する地理院タイル一枚一枚の所在情報である「地理院タイル目録」を整備し，提供実験に供している．地理院タイル一枚一枚の更新日付や MD5SUM を記録した地理院タイル目録を利用することにより，地理院タイルのダウンロード及び同期を効率的に進めることができる．国土地理院が実施している，週あたり数万タイルに及ぶ基本測量成果の迅速更新の状況を反映するため，地理院タイル目録の更新は週次のタイミングで実施しているところである．さらに，地理院タイル目録を用いて実際に地理院タイルを効率的にダウンロードし，ダウンロードした地理院タイルを地理院地図サーバの最新の地理院タイルに効率的に同期できるプログラム（リファレンス実装） qdltc を作成し公開した．qdltc を用いると，電子地形図（タイル）である地理院タイル（標準地図）約5,000万タイルを7日間程度でダウンロードでき，週毎の最新の地理院タイルへの同期（約数万タイル）を7時間程度で実施することができる．


## 背景
地理空間情報部情報普及課では，1880年代から取り組まれてきた地形図作成の最新の成果である基本測量成果「電子地形図（タイル）」を含むウェブ地図向け地理空間情報「地理院タイル」を提供している．「地理院タイル」は，基本図（地形図），写真（オルソ画像），主題図，災害情報を含む1,000レイヤを超える膨大な情報セットとなっている．

また，地理院タイル利用のショーケースとして，国土地理院のウェブ地図「地理院地図」（国土地理院，2015a）を運営している．地理院地図は，その前身である「電子国土ポータル」（平成15年（2003年）7月15日開設）から通算すると，平成27年7月で運営12周年となり，この間，24時間365日無停止を目標として運営を継続してきた．

地理院タイル及び地理院地図の提供を通じて，情報普及課は，国土地理院が捉える日本の姿を，ウェブを通じて日本や世界に継続的に提供している．

情報普及課では，平成27年7月現在，地理院タイルの活用を推進するための3つの施策として「オープンデータ施策，オープンソース施策，オープンイノベーション施策」を掲げている．

オープンデータ施策は，地理院タイルを政府オープンデータ戦略に基づきわかりやすい利用規約で多様な活用を推進することであり，平成26年（2014年）9月30日に政府標準利用規約（第1.0版）に基づく国土地理院コンテンツ利用規約が施行された日に，地理院タイルの利用規約を当該規約に移行している．国土地理院コンテンツ利用規約は「複製，公衆送信，翻訳・変形等の翻案等，自由に利用できます．商用利用も可能です」を基本精神とする利用規約であり，出典の掲載により自由に利用できることを原則としている．国土地理院コンテンツ利用規約は著作権法に関わる規約である一方，測量法は国土地理院コンテンツ利用規約でも個別法令として取り扱われる別個の規定であり，情報普及課においても，基本測量成果である地理院タイルについても，より円滑に測量法に基づく複製承認・使用承認申請ができるよう，技術者等と対話を進めているところである．

オープンソース施策は，地理院タイル利用のショーケースである地理院地図をオープンソースソフトウェアで構築し，構築した地理院地図自身もオープンソースソフトウェアとして提供する（国土地理院，2015b）という施策であり，平成24年（2012年）7月26日から開始されている．業界で共有すべき機能や技術を広く共有し，業界全体の技術競争力を底上げすることで，ウェブ地図を通じた地理空間情報の活用を推進することを目的としている．

オープンイノベーション施策は，外部との連携を積極活用し，連携する各主体がイノベーティブな成果を得ることを追求するものである．地理院タイル提供においてオープンイノベーションの考えを取り入れるのは，地理空間情報の多様なニーズ，特に多様な業務ニーズに対応するためには，それぞれの利用分野に明るい事業者との連携が必須であるためである．多様なニーズに国土地理院単独ではなく業界全体で応えるため，業界標準を見極めながら地理院地図の各機能のモジュール化を進め，機能を切り出したり入れ替えたりできる技術的環境を整えるとともに，受託開発者やツール提供者との情報共有・意見交換のための「地理院地図パートナーネットワーク」を平成26年（2014年）7月11日から開設し，平成26年（2014年）11月，平成27年（2015年）2月及び6月には「地理院地図パートナーネットワーク会議」を開催した．地理院地図の各機能のモジュール化の嚆矢としては，平成25年（2013年）10月30日の地理院タイルの「XYZ（slippy map tilenames）方式」採用が挙げられる．多くのソフトウェアが対応しているタイル命名規則を採用することにより，ソフトウェア間の自由な競争を促進し，多様な業務ニーズへの対応可能性が開かれた．地理院タイルに対応したデスクトップアプリケーションやモバイルアプリケーションが増加し，地理院地図自身も，平成27年（2015年）1月8日に，その依拠するウェブ地図ライブラリを OpenLayers から Leaflet に容易に移行することができた．また，地理院地図パートナーネットワークには，平成27年（2015年）6月30日現在121者の参加があり，これら地理院地図パートナーと呼ばれる参加者は，会議での議論に参加するほか，地理院地図パートナーネットワークのウェブサイト（国土地理院，2015c）で，地理院タイルのアプリケーションについての情報を集約した「地理院地図パートナーリスト」を共同で公開している．

また，情報普及課では，平成27年7月現在，地理院地図の今後を方向づける3つの技術として「標高タイル，ベクトルタイル，デジタルファブリケーション」を掲げている．

標高タイルは，基盤地図情報の数値標高モデルに基づく標高データをウェブ地図形式によって提供するものである．ウェブ地図用タイルデータの各ピクセルの位置について算出した標高値をタイルデータに格納し，いわば「pixel-perfect DEM for web maps」として提供するものであり，タイルデータのフォーマットには現在 CSV 形式を用いている（国土地理院，2013）．標高タイルは，地理院地図で地図中心の標高値をテキスト表示するためのバックデータとして使われる一方，平成26年（2014年）3月19日に公開された「地理院地図3D」（国土地理院，2015d）では，地形模型をウェブブラウザ上で表現するとともに3Dプリンタ用データとして出力するためのバックデータとしても使われている．また，首都大学東京渡邉研究室が公開している「ヒロシマ・アーカイブ」（ヒロシマアーカイブ制作委員会, 2015）では，アースブラウザを実現するライブラリである Cesium （Analytical Graphics, Inc., 2015） で地形を詳細に表現するために国土地理院の標高データがバックデータとして使われている（首都大学東京，2015）．

ベクトルタイルは，属性が付与された点・線・面のベクトルデータをウェブ地図形式によって提供するものである．平成26年（2014年）8月1日に提供区域を限定して道路中心線のベクトルタイルデータを提供実験に供して以来，段階的に提供実験を進め，平成27年（2015年）6月4日には，全国の注記ベクトルタイルを，地理院地図にも組み込む形で提供実験を開始した．ベクトルデータをタイル形式で配信することにより，ウェブブラウザ側での表現調整や処理等が可能となり，より多様な用途に対応することができるようになる．また，特に高精細なディスプレイを持つモバイルデバイス等では，レンダリングをデバイス側で行うことにより，地図をよりくっきりと提示することが可能となる．さらに，大量の情報もベクトルタイル形式で重ね合わせることでより容易にウェブ地図と連携できるようになった．地理院地図でも，過去の写真や地盤情報をベクトルタイルで重ね合わせることにより，大量のポイントデータをより大量に．より高速に提示することに成功している．

デジタルファブリケーションは，データに基づいて素材を加工し，多様にカスタマイズ可能なものづくりを可能とする技術体系であり，データのインターネット配信と加工機械のパーソナル化を前提とする技術体系となっている．地理空間情報部では地理院地図3Dの公開に先立って3Dプリンタを導入し，デジタルファブリケーションの世界に基盤地図情報に基づく地形模型を普及させた．地理空間情報を情報端末でも紙でもないメディアで活用することを提案することで，情報端末の電源の制約や汚損しやすい紙の性質から自由で，新しい理解を与える情報表現の世界を広げることを狙っている．新しい活用を亭亜することで，地理空間情報の活用推進をより活性化させることが目的である．

## 解決すべき課題
電子地形図の実績を踏まえ，地理院タイルの「標準地図」，「淡色地図」及び「English」を基本測量成果として安定供給できる状況が整ったことから，これらのデータについて平成26年7月1日付官報（本紙 第6322号）において測量法第27条第1項に基づく公告を実施した．これにより，これら3レイヤの総称として「電子地形図（タイル）」という名称の運用が開始され，当該データの安定的なインターネット提供及び迅速な更新が担保されることとなった．なお，その後，地理院タイルとなっている「数値地図25000（土地条件）」及び「数値地図5000（土地利用）」についても同様に基本測量成果としての取り扱いが開始された．

一方，これらの基本測量成果を測量法第27条第2項に基づき提供する手段としては，もっぱらインターネット提供を用いる方針となっており，情報普及課が運用する地理院地図タイル用ウェブサーバである「地理院地図サーバ」の可用性を確保しつつ，当該インターネット提供を適切に実施する必要があった．従前，紙地図を閲覧所で閲覧すること（測量法第27条第3項）に相当するウェブブラウザ等での閲覧を念頭に設計されていた地理院地図サーバに，新しい任務が追加されたことになる．特に，紙地図を書店で購入することに相当する，タイルデータのダウンロードについては，効率的な手段を拡充する必要が生じた．

基本測量成果である「電子地形図（タイル）」には，ほかの電子地形図シリーズと同様に，国土地理院の基本測量によるデータの迅速更新が反映されることになる．これにより，週あたり数万タイルの更新が行われることとなる．測量の精度確保の観点からも，これら迅速更新を，地理院地図サーバのみならず，ダウンロード頂いたデータセットにも効率的に適用する手段を提供する必要が生じた．データセットの時間精度要求は，利用者の用途により異なることから，同期を特定の頻度で行っていただくことを強制することはできない．このため，同期アルゴリズムは，同期するデータの鮮度がばらついていても適用できるようにする必要があった．

地理院タイルのダウンロード機能・性能の拡充の必要は，基本測量成果である地理院タイルに限定されない．基本測量成果ではない地理院タイルにおいても，国土地理院コンテンツ利用規約の「複製，公衆送信，翻訳・変形等の翻案等，自由に利用できます．商用利用も可能です」という基本精神を実践するためには，ただ地理院地図において地理院タイルを閲覧して頂くだけではなく，地理院タイルを必要に応じてダウンロードして頂き，さらには常に最新の地理院タイルに同期して頂く手段を提供することが必要となった．

地理院タイルを効率的にダウンロードし同期していただける機能が提供できない場合，当該データを総当たりで非効率にダウンロードするアクセスが増加し，地理院地図の可用性にも悪影響を及ぼす恐れがあった．

### 開かれる新たな応用

## 技術的詳細

## 地理院タイル目録

## ダウンローダ qldtc

## 今後の展開

## 参考文献
- 国土地理院（2015a）: 地理院地図, http://maps.gsi.go.jp/, (accessed 31 Jul. 2015)
- 国土地理院（2015b）: gsimaps(地理院地図), https://github.com/gsi-cyberjapan/gsimaps, (accessed 31 Jul. 2015)
- 国土地理院（2015c）: 地理院地図パートナーネットワーク, http://maps.gsi.go.jp/pn/, (accessed 31 Jul. 2015)
- 国土地理院（2013）: 標高タイルの詳細仕様, http://maps.gsi.go.jp/development/demtile.html, (accessed 31 Jul. 2015)
- 国土地理院（2015d）: 地理院地図3D, http://maps.gsi.go.jp/3d/, (accessed 31 Jul. 2015)
- ヒロシマアーカイブ制作委員会（2015）: ヒロシマ・アーカイブ, http://hiroshima.mapping.jp/, (accessed 31 Jul. 2015)
- Analytical Graphics, Inc. (2015): Cesium, http://cesiumjs.org, (accessed 31 Jul. 2015)
- 首都大学東京（2015）: 被爆資料を世界に発信する「ヒロシマ・アーカイブ」が大幅バージョンアップ～広島女学院中学高等学校との共同研究～, http://www.tmu.ac.jp/news/topics/11525.html, (accessed 31 Jul. 2015)
- 国土地理院（2015）: 地理院タイル目録ベースのダウンローダ（参照実装）, https://github.com/gsi-cyberjapan/qdltc,  (accessed 31 Jul. 2015)
